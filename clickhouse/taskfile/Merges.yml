version: "3"

tasks:
  current:
    desc: show current merges
    cmds:
      - task: :query
        vars:
          query: |
            SELECT hostname(), table, result_part_name part_name, merge_algorithm,
                   length(source_part_names) src_parts,
                   round(elapsed) as elapsed,
                   round(progress*100, 4) pct,
                   formatReadableSize(total_size_bytes_compressed) as on_disk,
                   formatReadableSize(memory_usage) AS memory_usage
              FROM cluster({{ $.cluster }}, system, merges)
             WHERE database='{{ $.database }}' AND table LIKE '{{ $.table }}'
             ORDER BY elapsed DESC

  latest:
    desc: show latest merges
    cmds:
      - task: :query
        vars:
          query: |
            SELECT hostname(), table, part_name,
                   length(merged_from) src_parts,
                   rows,
                   duration_ms,
                   formatReadableSize(size_in_bytes) on_disk,
                   formatReadableSize(peak_memory_usage) memory_usage
              FROM cluster({{ $.cluster }}, system, part_log)
             WHERE database='{{ $.database }}' AND table LIKE '{{ $.table }}' AND event_date = today()
               AND event_type='MergeParts'
             ORDER BY event_time DESC
             LIMIT {{ $.limit }}